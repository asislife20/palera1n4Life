name: build-linux-armel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ARCH: armel
      SYSROOT: ${{ github.workspace }}/sysroot
      HOST: armel-linux-musleabi
      PREFIX: /usr/local
      DESTDIR: ${{ github.workspace }}/sysroot

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential autoconf automake libtool pkg-config \
            libusb-1.0-0-dev libreadline-dev

      - name: Create sysroot dirs
        run: |
          mkdir -p "$SYSROOT/usr/local"
          mkdir -p "$SYSROOT/usr/local/include"
          mkdir -p "$SYSROOT/usr/local/lib"
          mkdir -p "$SYSROOT/usr/local/bin"

      - name: Create retry wrapper
        run: |
          cat << 'EOF' > retry.sh
          retry() {
            for i in {1..5}; do
              "$@" && return 0
              echo "Retry $i failed, waiting..."
              sleep 5
            done
            echo "All retries failed!"
            return 1
          }
          export -f retry
          EOF

      - name: Source retry
        run: |
          source retry.sh

      - name: Define .la patcher (V3)
        run: |
          cat << 'EOF' > patch_la.sh
          patch_la() {
            echo "Patching all .la files inside $DESTDIR/usr/local/lib ..."
            find "$DESTDIR/usr/local/lib" -name "*.la" | while read la; do
              echo "Patching $la"
              sed -i "s|libdir='/usr/local/lib'|libdir='$DESTDIR/usr/local/lib'|" "$la"
              sed -i "s|/usr/local/lib|$DESTDIR/usr/local/lib|g" "$la"
            done
          }
          export -f patch_la
          EOF

      - name: Source patch_la
        run: |
          source patch_la.sh

      ####################################################################
      # BUILD: LIBPLIST
      ####################################################################
      - name: Clone libplist
        run: retry git clone https://github.com/libimobiledevice/libplist

      - name: Build libplist
        run: |
          cd libplist
          ./autogen.sh --host=$HOST --prefix=$PREFIX
          make -j$(nproc)
          make install DESTDIR="$DESTDIR"
          patch_la

      ####################################################################
      # BUILD: libimobiledevice-glue
      ####################################################################
      - name: Clone glue
        run: retry git clone https://github.com/libimobiledevice/libimobiledevice-glue

      - name: Build glue
        run: |
          cd libimobiledevice-glue
          PKG_CONFIG_PATH="$DESTDIR/usr/local/lib/pkgconfig" \
          ./autogen.sh --host=$HOST --prefix=$PREFIX
          make -j$(nproc)
          make install DESTDIR="$DESTDIR"
          patch_la

      ####################################################################
      # BUILD: libirecovery
      ####################################################################
      - name: Clone libirecovery
        run: retry git clone https://github.com/libimobiledevice/libirecovery

      - name: Build libirecovery
        run: |
          cd libirecovery
          PKG_CONFIG_PATH="$DESTDIR/usr/local/lib/pkgconfig" \
          ./autogen.sh --host=$HOST --prefix=$PREFIX
          make -j$(nproc)
          make install DESTDIR="$DESTDIR"
          patch_la

      ####################################################################
      # OUTPUT
      ####################################################################
      - name: Archive sysroot
        uses: actions/upload-artifact@v4
        with:
          name: linux-armel-libs
          path: ${{ github.workspace }}/sysroot
