name: Build palera1n (Linux ARMEL)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-linux-armel:
    runs-on: ubuntu-latest

    env:
      PREFIX: /usr/local
      MBEDTLS_VERSION: 3.5.2
      LIBPLIST_COMMIT: 2117b8fdb6b4096455bd2041a63e59a028120136
      LIBIMOBILEDEVICE_GLUE_COMMIT: 362f7848ac89b74d9dd113b38b51ecb601f76094
      LIBIRECOVERY_COMMIT: 7ce02c347b7c26e59498e6af31c9da51018d0fa1
      LIBIMOBILEDEVICE_COMMIT: ed0d66d0341562731bb19928dfe48155509fa7a7
      LIBUSBMUXD_COMMIT: a7f0543fb1ecb20ac7121c0fd77297200e0e43fc

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config autoconf automake autopoint libtool \
            build-essential mandoc libusb-1.0-0-dev libreadline-dev
          sudo pip3 install jsonschema jinja2

      ##############################################################
      # Define retry() function
      ##############################################################
      - name: Define retry function
        shell: bash
        run: |
          retry() { 
            for i in {1..5}; do 
              "$@" && break || sleep 5; 
            done 
          }
          export -f retry

      ##############################################################
      # Toolchain Download
      ##############################################################

      - name: Download ARMEL toolchain
        run: |
          curl -L -o dep_root_armel.tgz \
            https://cdn.nickchan.lol/palera1n/c-rewrite/releases/v2.2.1/build_depends/dep_root_armel-linux-musleabi.tgz

      - name: Extract toolchain
        run: |
          mkdir -p dep_root
          tar -xzf dep_root_armel.tgz -C dep_root

      ##############################################################
      # Setup Cross Environment
      ##############################################################

      - name: Configure cross environment
        run: |
          echo "TOOLCHAIN_DIR=$(pwd)/dep_root" >> $GITHUB_ENV
          echo "$(pwd)/dep_root/bin" >> $GITHUB_PATH
          echo "CROSS_COMPILE=armel-linux-musleabi-" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(pwd)/dep_root/usr/local/lib/pkgconfig" >> $GITHUB_ENV
          echo "PKG_CONFIG_LIBDIR=$(pwd)/sysroot/usr/local/lib/pkgconfig" >> $GITHUB_ENV

          echo "DESTDIR=$(pwd)/sysroot" >> $GITHUB_ENV

          echo "CFLAGS=-g \
            -I$(pwd)/dep_root/usr/local/include \
            -I$(pwd)/dep_root/usr/local/include/libusb-1.0 \
            -I$(pwd)/sysroot/usr/local/include \
            -I$(pwd)/sysroot/usr/local/include/libusb-1.0" >> $GITHUB_ENV

          echo "LDFLAGS=-g -L$(pwd)/dep_root/usr/local/lib" >> $GITHUB_ENV

      ##############################################################
      # Build libplist
      ##############################################################
      - name: Build libplist
        run: |
          retry git clone https://github.com/libimobiledevice/libplist
          cd libplist
          git reset --hard $LIBPLIST_COMMIT
          autoreconf -fi
          mkdir -p ../sysroot/usr/local/include/plist
          ./configure \
            --host=armel-linux-musleabi \
            --prefix=/usr/local \
            --disable-shared \
            --enable-static
          make -j$(nproc)
          make install DESTDIR="$DESTDIR"

      ##############################################################
      # Build libimobiledevice-glue
      ##############################################################
      - name: Build libimobiledevice-glue
        run: |
          retry git clone https://github.com/libimobiledevice/libimobiledevice-glue
          cd libimobiledevice-glue
          git reset --hard $LIBIMOBILEDEVICE_GLUE_COMMIT
          autoreconf -fi

          mkdir -p /usr/local/include/plist
          mkdir -p dep_root/usr/local/include/plist
          mkdir -p sysroot/usr/local/include/plist
          cp -a ../sysroot/usr/local/include/plist/* dep_root/usr/local/include/plist/ || true

          ./configure \
            --host=armel-linux-musleabi \
            --prefix=/usr/local \
            --disable-shared \
            --enable-static

          make -j$(nproc)
          make install DESTDIR="$DESTDIR"

      ##############################################################
      # Build libirecovery
      ##############################################################
      - name: Build libirecovery
        run: |
          retry git clone https://github.com/libimobiledevice/libirecovery
          cd libirecovery
          git reset --hard $LIBIRECOVERY_COMMIT
          autoreconf -fi

          ./configure \
            --host=armel-linux-musleabi \
            --prefix=/usr/local \
            --disable-shared \
            --enable-static

          make -j$(nproc)
          make install DESTDIR="$DESTDIR"

      ##############################################################
      # Build libimobiledevice
      ##############################################################
      - name: Build libimobiledevice
        run: |
          retry git clone https://github.com/libimobiledevice/libimobiledevice
          cd libimobiledevice
          git reset --hard $LIBIMOBILEDEVICE_COMMIT
          autoreconf -fi

          ./configure \
            --host=armel-linux-musleabi \
            --prefix=/usr/local \
            --disable-shared \
            --enable-static \
            --with-mbedtls \
            --disable-debug \
            --disable-wireless-pairing

          make -j$(nproc)
          make install DESTDIR="$DESTDIR"

      ##############################################################
      # Build usbmuxd
      ##############################################################
      - name: Build libusbmuxd
        run: |
          retry git clone https://github.com/libimobiledevice/libusbmuxd
          cd libusbmuxd
          git reset --hard $LIBUSBMUXD_COMMIT
          autoreconf -fi

          ./configure \
            --host=armel-linux-musleabi \
            --prefix=/usr/local \
            --disable-shared \
            --enable-static

          make -j$(nproc)
          make install DESTDIR="$DESTDIR"

      ##############################################################
      # Fix libusb header paths
      ##############################################################
      - name: Fix libusb headers
        run: |
          mkdir -p dep_root/usr/local/include
          cp -a sysroot/usr/local/include/libusb-1.0 dep_root/usr/local/include/
          echo "libusb headers copied:"
          ls -R dep_root/usr/local/include/libusb-1.0

      ##############################################################
      # Merge sysroot into toolchain
      ##############################################################
      - name: Merge sysroot libs into dep_root
        run: |
          cp -a sysroot/usr/local/include/* dep_root/usr/local/include/ || true
          cp -a sysroot/usr/local/lib/* dep_root/usr/local/lib/ || true

      ##############################################################
      # Build palera1n
      ##############################################################
      - name: Build palera1n (linux-armel)
        run: |
          make clean || true
          make linux-armel

      ##############################################################
      # Upload artifact
      ##############################################################
      - name: Upload palera1n artifact
        uses: actions/upload-artifact@v4
        with:
          name: palera1n-linux-armel
          path: palera1n
