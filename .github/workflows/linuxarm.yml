name: Build palera1n (Linux ARMEL)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-linux-armel:
    runs-on: ubuntu-latest

    env:
      PREFIX: /usr/local
      MBEDTLS_VERSION: 3.5.2
      LIBPLIST_COMMIT: 2117b8fdb6b4096455bd2041a63e59a028120136
      LIBIMOBILEDEVICE_GLUE_COMMIT: 362f7848ac89b74d9dd113b38b51ecb601f76094
      LIBIRECOVERY_COMMIT: 7ce02c347b7c26e59498e6af31c9da51018d0fa1
      LIBIMOBILEDEVICE_COMMIT: ed0d66d0341562731bb19928dfe48155509fa7a7
      LIBUSBMUXD_COMMIT: a7f0543fb1ecb20ac7121c0fd77297200e0e43fc

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config autoconf automake autopoint libtool \
            build-essential mandoc libusb-1.0-0-dev \
            libreadline-dev
          sudo pip3 install jsonschema jinja2

      ######################################################
      # 1. Download and extract ARMEL toolchain
      ######################################################

      - name: Download ARMEL toolchain
        run: |
          curl -L -o dep_root_armel.tgz \
            https://cdn.nickchan.lol/palera1n/c-rewrite/releases/v2.2.1/build_depends/dep_root_armel-linux-musleabi.tgz

      - name: Verify download
        run: ls -lh

      - name: Extract toolchain
        run: |
          mkdir -p dep_root
          tar -xzf dep_root_armel.tgz -C dep_root
 
      - name: Debug libusb location
        run: |
          echo "Searching for libusb.h..."
          find dep_root -name "libusb.h" -type f -maxdepth 6 || true

          echo "Searching for libusb-1.0 directory..."
          find dep_root -name "libusb-1.0" -type d -maxdepth 6 || true

          echo "Listing include directories..."
          find dep_root -type d -path "*/include*" -maxdepth 6

      ######################################################
      # 2. Configure cross environment (FIXED)
      ######################################################

      - name: Setup cross environment
        run: |
          echo "TOOLCHAIN_DIR=$(pwd)/dep_root" >> $GITHUB_ENV
          echo "$(pwd)/dep_root/bin" >> $GITHUB_PATH

          echo "CROSS_COMPILE=armel-linux-musleabi-" >> $GITHUB_ENV
          echo "DESTDIR=$(pwd)/sysroot" >> $GITHUB_ENV

          # Critical: FORCE pkg-config to use ARMEL libs ONLY
          echo "PKG_CONFIG_LIBDIR=$(pwd)/sysroot/usr/local/lib/pkgconfig" >> $GITHUB_ENV

          # fallback
          echo "PKG_CONFIG_PATH=$(pwd)/dep_root/usr/local/lib/pkgconfig" >> $GITHUB_ENV

          echo "CFLAGS=-g -I$(pwd)/dep_root/usr/local/include -I$(pwd)/sysroot/usr/local/include -D_FILE_OFFSET_BITS=64 -D_TIME_BITS=64" >> $GITHUB_ENV
          echo "LDFLAGS=-g -L$(pwd)/dep_root/usr/local/lib -L$(pwd)/sysroot/usr/local/lib" >> $GITHUB_ENV

      ######################################################
      # 3. Build libplist
      ######################################################

      - name: Build libplist
        run: |
          git clone https://github.com/libimobiledevice/libplist
          cd libplist
          git reset --hard $LIBPLIST_COMMIT
          autoreconf -fi
          ./configure \
            --host=armel-linux-musleabi \
            --prefix=/usr/local \
            --disable-shared \
            --enable-static
          make -j$(nproc)
          make install DESTDIR="$DESTDIR"

      ######################################################
      # 4. Build libimobiledevice-glue
      ######################################################

      - name: Build libimobiledevice-glue
        run: |
          git clone https://github.com/libimobiledevice/libimobiledevice-glue
          cd libimobiledevice-glue
          git reset --hard $LIBIMOBILEDEVICE_GLUE_COMMIT
          autoreconf -fi
          ./configure \
            --host=armel-linux-musleabi \
            --prefix=/usr/local \
            --disable-shared \
            --enable-static
          make -j$(nproc)
          make install DESTDIR="$DESTDIR"

      ######################################################
      # 5. Build libirecovery (WITH FULL libusb FIX)
      ######################################################

      - name: Build libirecovery
        run: |
          git clone https://github.com/libimobiledevice/libirecovery
          cd libirecovery
          git reset --hard $LIBIRECOVERY_COMMIT
          autoreconf -fi

          # FIX: Include BOTH libusb header paths
          export libusb_CFLAGS="-I$(pwd)/../dep_root/usr/include -I$(pwd)/../dep_root/usr/include/libusb-1.0"
          export libusb_LIBS="-L$(pwd)/../dep_root/usr/lib -lusb-1.0"

          ./configure \
            --host=armel-linux-musleabi \
            --prefix=/usr/local \
            --disable-shared \
            --enable-static \
            CFLAGS="$CFLAGS $libusb_CFLAGS" \
            LDFLAGS="$LDFLAGS $libusb_LIBS" \
            libusb_CFLAGS="$libusb_CFLAGS" \
            libusb_LIBS="$libusb_LIBS"

          make -j$(nproc)
          make install DESTDIR="$DESTDIR"


      ######################################################
      # 6. Build libimobiledevice
      ######################################################

      - name: Build libimobiledevice
        run: |
          git clone https://github.com/libimobiledevice/libimobiledevice
          cd libimobiledevice
          git reset --hard $LIBIMOBILEDEVICE_COMMIT
          autoreconf -fi
          ./configure \
            --host=armel-linux-musleabi \
            --prefix=/usr/local \
            --disable-shared \
            --enable-static \
            --with-mbedtls \
            --disable-debug \
            --disable-wireless-pairing
          make -j$(nproc)
          make install DESTDIR="$DESTDIR"

      ######################################################
      # 7. Build libusbmuxd
      ######################################################

      - name: Build libusbmuxd
        run: |
          git clone https://github.com/libimobiledevice/libusbmuxd
          cd libusbmuxd
          git reset --hard $LIBUSBMUXD_COMMIT
          autoreconf -fi
          ./configure \
            --host=armel-linux-musleabi \
            --prefix=/usr/local \
            --disable-shared \
            --enable-static
          make -j$(nproc)
          make install DESTDIR="$DESTDIR"

      ######################################################
      # 8. Merge sysroot into toolchain (required)
      ######################################################

      - name: Merge sysroot into dep_root
        run: |
          cp -a sysroot/usr/local/lib/* dep_root/usr/local/lib/ || true
          cp -a sysroot/usr/local/include/* dep_root/usr/local/include/ || true

      ######################################################
      # 9. Build palera1n (linux-armel)
      ######################################################

      - name: Build palera1n (linux-armel)
        run: |
          make clean || true
          make linux-armel

      ######################################################
      # 10. Upload build artifact
      ######################################################

      - name: Upload palera1n artifact
        uses: actions/upload-artifact@v4
        with:
          name: palera1n-linux-armel
          path: palera1n
