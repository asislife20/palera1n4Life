name: Build palera1n (Linux ARMEL only)

on:
  workflow_dispatch:

jobs:
  build-Linux-armel:
    runs-on: ubuntu-latest
    env:
      MBEDTLS_VERSION: 3.5.2
      LIBUSB_VERSION: 1.0.27
      READLINE_VERSION: 8.2
      GPM_VERSION: 1.20.7
      LIBIMOBILEDEVICE_COMMIT: ed0d66d0341562731bb19928dfe48155509fa7a7
      LIBIRECOVERY_COMMIT: 7ce02c347b7c26e59498e6af31c9da51018d0fa1
      LIBIMOBILEDEVICE_GLUE_COMMIT: 362f7848ac89b74d9dd113b38b51ecb601f76094
      USBMUXD_COMMIT: bc0b91ca856811f4393318dc83db6dc3c1ac326d
      LIBPLIST_COMMIT: 2117b8fdb6b4096455bd2041a63e59a028120136
      LIBUSBMUXD_COMMIT: a7f0543fb1ecb20ac7121c0fd77297200e0e43fc

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config autoconf automake autopoint mandoc
          sudo pip3 install jsonschema jinja2

      # ðŸ”¥ Download your working toolchain (NO auth needed)
      - name: Download ARMEL toolchain
        run: |
          curl -L \
            -o dep_root_armel-linux-musleabi.tgz \
            https://cdn.nickchan.lol/palera1n/c-rewrite/releases/v2.2.1/build_depends/dep_root_armel-linux-musleabi.tgz

      # ðŸ” Debug â€” show directory contents
      - name: DEBUG â€” List directory contents
        run: |
          echo "PWD: $(pwd)"
          ls -lah

      # ðŸ“¦ Extract toolchain
      - name: Extract toolchain
        run: |
          mkdir -p dep_root
          tar -xzf dep_root_armel-linux-musleabi.tgz -C dep_root

      # ðŸ— Set up environment for cross-compiling
      - name: Setup environment
        run: |
          export TOOLCHAIN_DIR="$(pwd)/dep_root"
          echo "${TOOLCHAIN_DIR}/bin" >> $GITHUB_PATH

          echo "CHECKRA1N_NAME=linux-armel" >> $GITHUB_ENV
          echo "ARCH_NAME=armel" >> $GITHUB_ENV

          echo "PKG_CONFIG_PATH=${TOOLCHAIN_DIR}/usr/local/lib/pkgconfig" >> $GITHUB_ENV
          echo "CFLAGS=-g -I${TOOLCHAIN_DIR}/usr/local/include -L${TOOLCHAIN_DIR}/usr/local/lib -D_FILE_OFFSET_BITS=64 -D_TIME_BITS=64" >> $GITHUB_ENV
          echo "CXXFLAGS=-g -I${TOOLCHAIN_DIR}/usr/local/include -L${TOOLCHAIN_DIR}/usr/local/lib -D_FILE_OFFSET_BITS=64 -D_TIME_BITS=64" >> $GITHUB_ENV
          echo "LDFLAGS=-g -L${TOOLCHAIN_DIR}/usr/local/lib" >> $GITHUB_ENV

          echo "CROSS_COMPILE=armel-linux-musleabi-" >> $GITHUB_ENV
          echo "PREFIX=/usr/local" >> $GITHUB_ENV
          echo "DESTDIR=$(pwd)/sysroot" >> $GITHUB_ENV

      # Continue with your regular build steps afterwards:
      # - mbedtls build
      # - libplist
      # - libimobiledevice
      # - usbmuxd
      # - palera1n compile
